name: üîÑ Workflows Combinados (Limpeza, Deploy, Exclus√£o)

# N√£o coloque 'on' aqui no n√≠vel raiz para evitar conflitos
# Cada job ser√° definido com seu pr√≥prio gatilho dentro de 'jobs'

jobs:
  # ‚úÖ 1. JOB: Excluir Arquivos da Raiz
  delete-files:
    name: üóëÔ∏è Excluir Arquivos da Raiz
    runs-on: ubuntu-latest
    permissions:
      contents: write

    on:
      schedule:
        - cron: '0 15 * * *'  # Executa √†s 12h BRT (15h UTC)
      workflow_dispatch:

    steps:
      - name: ‚è∞ Configurar fuso hor√°rio
        run: |
          sudo timedatectl set-timezone America/Fortaleza
          date

      - name: üßæ Clonar reposit√≥rio
        uses: actions/checkout@v3

      - name: üóëÔ∏è Excluir arquivos da raiz
        run: |
          rm -f 3wk1y24kx7uzdevxygz7
          rm -f 782dyqdrqkh1xegen4zp
          rm -f PiauiTV.m3u
          rm -f epgbrasil.m3u
          rm -f epgbrasil.xml
          rm -f epgbrasil.xml.gz
          rm -f epgbrasilportugal.m3u
          rm -f epgbrasilportugal.xml
          rm -f epgbrasilportugal.xml.gz
          rm -f epgportugal.m3u
          rm -f epgportugal.xml
          rm -f epgportugal.xml.gz
          rm -f jq2zy9epr3bwxmgwyxr5
          rm -f m3u4u_proton.me.m3u
          rm -f m3u@proton.me.m3u
          rm -f piauitv.m3u
          rm -f playlist.m3u
          rm -f playlists.log
          rm -f playlists.m3u
          rm -f pornstars.m3u
          rm -f proton.m3u

      - name: ‚úÖ Commit e Push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .
          git commit -m "üóëÔ∏è Excluir arquivos via GitHub Actions (agendado)" || echo "Nada a commitar"
          git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git HEAD:main


  # ‚úÖ 2. JOB: Limpar Execu√ß√µes de Workflow Antigas
  cleanup:
    name: üßπ Limpar Execu√ß√µes de Workflow Antigas (1h)
    runs-on: ubuntu-latest
    permissions:
      actions: write

    on:
      schedule:
        - cron: '1 */12 * * *'  # A cada 12h no minuto 1
      workflow_dispatch:

    steps:
      - name: üóëÔ∏è Deletar execu√ß√µes de workflow antigas
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Iniciando verifica√ß√£o de execu√ß√µes com mais de 1 hora..."
          now=$(date -u +%s)
          per_page=100
          page=1
          deleted=0

          while true; do
            echo "üìÑ Buscando p√°gina $page de execu√ß√µes..."
            runs=$(gh api \
              -H "Accept: application/vnd.github.v3+json" \
              "/repos/${{ github.repository }}/actions/runs?per_page=$per_page&page=$page" \
              --jq '.workflow_runs[] | {id, created_at, status}')

            if [ -z "$runs" ]; then
              echo "‚úÖ Nenhuma execu√ß√£o encontrada na p√°gina $page. Fim da pagina√ß√£o."
              break
            fi

            echo "$runs" | jq -c 'select(.created_at != null)' | while read -r run; do
              id=$(echo "$run" | jq -r '.id')
              created_at=$(echo "$run" | jq -r '.created_at')

              if date -u -d "$created_at" >/dev/null 2>&1; then
                run_date=$(date -u -d "$created_at" +%s)
              elif date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" >/dev/null 2>&1; then
                run_date=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" +%s)
              else
                echo "‚ö†Ô∏è Data inv√°lida: $created_at"
                continue
              fi

              diff_hours=$(( (now - run_date) / 3600 ))

              if [ "$diff_hours" -ge 1 ]; then
                echo "üóëÔ∏è Deletando execu√ß√£o ID: $id (Criada h√° $diff_hours horas)"
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github.v3+json" \
                  "/repos/${{ github.repository }}/actions/runs/$id" \
                  >/dev/null 2>&1 && deleted=$((deleted + 1)) || echo "‚ö†Ô∏è Falha ao deletar execu√ß√£o ID: $id"
              else
                echo "‚úÖ Execu√ß√£o ID: $id tem apenas $diff_hours horas ‚Äî ser√° mantida."
              fi
            done

            page=$((page + 1))
          done

          echo "üèÅ Processo conclu√≠do. Total de execu√ß√µes deletadas: $deleted"


  # ‚úÖ 3. JOB: Disparar Deploy Manual para GitHub Pages
  deploy:
    name: üöÄ Disparar Deploy Manual para GitHub Pages
    runs-on: ubuntu-latest
    environment: production
    env:
      TZ: America/Fortaleza

    on:
      workflow_dispatch:
      schedule:
        - cron: '25 10 * * *'  # 10h UTC = 7h BRT

    steps:
      - name: Executar deploy do pages-build-deployment
        env:
          TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/pages-build-deployment.yml/dispatches \
            -d '{"ref":"main"}'
