name: ðŸ”„ Workflows Combinados (ExclusÃ£o, Limpeza, Deploy)

on:
  schedule:
    # Executa a cada hora para verificar se algum job precisa rodar
    - cron: '0 * * * *'  # Toda hora, no minuto 0
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
    inputs:
      force_job:
        description: 'ForÃ§ar execuÃ§Ã£o de um job especÃ­fico (delete|cleanup|deploy)'
        required: false
        default: ''

env:
  TZ: America/Fortaleza

jobs:
  # âœ… 1. JOB: Excluir Arquivos da Raiz
  delete-files:
    name: ðŸ—‘ï¸ Excluir Arquivos da Raiz
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # Executa apenas se for 15h UTC (12h BRT)
    if: >-
      github.event.inputs.force_job == 'delete' ||
      (github.event_name == 'schedule' && 
      ${{ github.event.schedule == '0 15 * * *' }})

    steps:
      - name: â° Configurar fuso horÃ¡rio
        run: |
          sudo timedatectl set-timezone America/Fortaleza
          date

      - name: ðŸ§¾ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: ðŸ—‘ï¸ Excluir arquivos da raiz
        run: |
          rm -f 3wk1y24kx7uzdevxygz7
          rm -f 782dyqdrqkh1xegen4zp
          rm -f PiauiTV.m3u
          rm -f epgbrasil.m3u
          rm -f epgbrasil.xml
          rm -f epgbrasil.xml.gz
          rm -f epgbrasilportugal.m3u
          rm -f epgbrasilportugal.xml
          rm -f epgbrasilportugal.xml.gz
          rm -f epgportugal.m3u
          rm -f epgportugal.xml
          rm -f epgportugal.xml.gz
          rm -f jq2zy9epr3bwxmgwyxr5
          rm -f m3u4u_proton.me.m3u
          rm -f m3u@proton.me.m3u
          rm -f piauitv.m3u
          rm -f playlist.m3u
          rm -f playlists.log
          rm -f playlists.m3u
          rm -f pornstars.m3u
          rm -f proton.m3u

      - name: âœ… Commit e Push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .
          git commit -m "ðŸ—‘ï¸ Excluir arquivos via GitHub Actions" || echo "Nada a commitar"
          git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git HEAD:main


  # âœ… 2. JOB: Limpar ExecuÃ§Ãµes Antigas
  cleanup:
    name: ðŸ§¹ Limpar ExecuÃ§Ãµes de Workflow Antigas (12h)
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: ðŸ” Verificar se Ã© hora de executar o cleanup
        id: check_time
        run: |
          # ObtÃ©m a hora atual em UTC
          current_hour=$(date -u +%H)
          current_min=$(date -u +%M)

          # O cron Ã© '1 */12 * * *' â†’ 00:01 e 12:01 UTC
          if [[ "$current_hour" == "00" && "$current_min" == "01" ]] || \
             [[ "$current_hour" == "12" && "$current_min" == "01" ]] || \
             [[ "${{ github.event.inputs.force_job }}" == "cleanup" ]]; then
            echo "run_cleanup=true" >> $GITHUB_ENV
          else
            echo "run_cleanup=false" >> $GITHUB_ENV
          fi

      - name: ðŸ—‘ï¸ Deletar execuÃ§Ãµes de workflow antigas
        if: env.run_cleanup == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Iniciando verificaÃ§Ã£o de execuÃ§Ãµes com mais de 1 hora..."
          now=$(date -u +%s)
          per_page=100
          page=1
          deleted=0

          while true; do
            echo "ðŸ“„ Buscando pÃ¡gina $page de execuÃ§Ãµes..."
            runs=$(gh api \
              -H "Accept: application/vnd.github.v3+json" \
              "/repos/${{ github.repository }}/actions/runs?per_page=$per_page&page=$page" \
              --jq '.workflow_runs[] | {id, created_at}')

            if [ -z "$runs" ]; then
              echo "âœ… Nenhuma execuÃ§Ã£o encontrada na pÃ¡gina $page. Fim da paginaÃ§Ã£o."
              break
            fi

            echo "$runs" | jq -c 'select(.created_at != null)' | while read -r run; do
              id=$(echo "$run" | jq -r '.id')
              created_at=$(echo "$run" | jq -r '.created_at')

              # Converter data para timestamp (compatÃ­vel com Linux e macOS)
              if date -u -d "$created_at" >/dev/null 2>&1; then
                run_date=$(date -u -d "$created_at" +%s)
              elif date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" >/dev/null 2>&1; then
                run_date=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" +%s)
              else
                echo "âš ï¸ Data invÃ¡lida: $created_at"
                continue
              fi

              diff_hours=$(( (now - run_date) / 3600 ))

              if [ "$diff_hours" -ge 1 ]; then
                echo "ðŸ—‘ï¸ Deletando execuÃ§Ã£o ID: $id (Criada hÃ¡ $diff_hours horas)"
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github.v3+json" \
                  "/repos/${{ github.repository }}/actions/runs/$id" \
                  >/dev/null 2>&1 && deleted=$((deleted + 1)) || echo "âš ï¸ Falha ao deletar execuÃ§Ã£o ID: $id"
              else
                echo "âœ… ExecuÃ§Ã£o ID: $id tem apenas $diff_hours horas â€” serÃ¡ mantida."
              fi
            done

            page=$((page + 1))
          done

          echo "ðŸ Processo concluÃ­do. Total de execuÃ§Ãµes deletadas: $deleted"
          
  # âœ… 3. JOB: Disparar Deploy Manual para GitHub Pages
  deploy:
    name: ðŸš€ Disparar Deploy Manual para GitHub Pages
    runs-on: ubuntu-latest
    environment: production

    # Executa Ã s 10h25 UTC (7h25 BRT)
    if: >-
      github.event.inputs.force_job == 'deploy' ||
      (github.event_name == 'schedule' && 
      ${{ github.event.schedule == '25 10 * * *' }})

    steps:
      - name: Executar deploy do pages-build-deployment
        env:
          TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/pages-build-deployment.yml/dispatches \
            -d '{"ref":"main"}'
